# -*- coding: utf-8 -*-

# Form implementation generated from reading ui file 'GUI.ui'
#
# Created by: PyQt5 UI code generator 5.15.9
#
# WARNING: Any manual changes made to this file will be lost when pyuic5 is
# run again.  Do not edit this file unless you know what you are doing.


from PyQt5 import QtCore, QtGui, QtWidgets
import sys
import webbrowser
from PyQt5.QtWidgets import *
from PyQt5.QtCore import *
from PyQt5.QtGui import *
from CA_install import *
from mitm_start import *
from jdsd_main import *
from mail import *
from image import *
import datetime
import multiprocessing
class MyThread(QThread):
    signal_label=pyqtSignal(str)
    signal_p=pyqtSignal(int)
    def __init__(self,mail_line):
        super(MyThread, self).__init__()
        self.mail_line=mail_line
    def __del__(self):
        self.wait()
    def run(self):
        global index
        if progress[index].is_alive():
               progress[index].terminate()
               progress[index].join()
               index=index+1
        begin=time.time()
        while(1):
                ret=os.system("ping baidu.com -n 1")
                if ret==0:
                        break
                else :
                        self.signal_label.emit("æ­£åœ¨ç­‰å¾…ç½‘ç»œè¿æ¥......")
                        time.sleep(1)
                        error=time.time()
                        if(error-begin>60):
                                self.signal_label.emit("é”™è¯¯!è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥ï¼")
                                return
        ##é‚®ç®±åˆ¤æ–­
        mail=mail_judge()
        if mail=="":
                if self.mail_line=="":
                        self.signal_label.emit("é”™è¯¯!è¯·è¾“å…¥æ‚¨çš„é‚®ç®±ï¼")   
                        return
                if check(self.mail_line)==0:
                        self.signal_label.emit("é”™è¯¯!è¯·æ£€æŸ¥ä½ çš„é‚®ç®±æ ¼å¼ï¼")   
                        return
                mail_insert(self.mail_line)
        if mail!=self.mail_line:
                if check(self.mail_line)==0:
                        self.signal_label.emit("é”™è¯¯!è¯·æ£€æŸ¥ä½ çš„é‚®ç®±æ ¼å¼!")   
                        return
        if mitm_install()==0:
                if not is_admin():
                        self.signal_label.emit("è¯ä¹¦æœªå®‰è£…ï¼è¯·ç”¨ç®¡ç†å‘˜æ¨¡å¼æ‰“å¼€ç¨‹åºâœ…")   
                        return
                else:
                        self.signal_label.emit("æ­£åœ¨ä¸‹è½½è¯ä¹¦......")
                        progress[index].start()
                        time.sleep(3)
                        progress[index].terminate()
                        progress[index].join()
                        index=index+1
                        path=CA_down()
                        self.signal_p.emit(1)
                        subprocess.call(["certutil", "-addstore","root",path])

        if mitm_install()==0:
                self.signal_label.emit("è¯ä¹¦å®‰è£…å¤±è´¥")     
                self.signal_p.emit(0)     
                return

        self.signal_label.emit("è¯ä¹¦å·²å®‰è£…âœ…") 
        self.signal_p.emit(2) 
        time.sleep(2)

        info_user,info_key=user_key_judge()

        if info_user=="" or info_key=="":
                begin=time.time()
                set_proxy()
                progress[index].start()
                end=time.time()
                self.signal_label.emit("è¯·åœ¨ä¸€åˆ†é’Ÿå†…æ‰“å¼€ç™»å½•è¿‡çš„ç»å…¸è¯µè¯»......")        
                while end-begin<60:
                        time.sleep(1)
                        end=time.time()
                        info_user,info_key=user_key_judge()     
                        if info_user!="" or info_key!="":
                                self.signal_label.emit("keyå€¼è·å–å®Œæ¯•âœ…") 
                                self.signal_p.emit(3)
                                time.sleep(2)                     
                                progress[index].terminate()
                                progress[index].join()
                                close_proxy()
                                break
                if end-begin>60:
                        self.signal_label.emit("æœªæ‰“å¼€ç»å…¸è¯µè¯»ï¼è¯·æŒ‰é‡æ–°å¼€å§‹ï¼") 
                        progress[index].terminate()
                        progress[index].join()
                        close_proxy()
                index=index+1
        if info_user!="" or info_key!="":
                mail=mail_judge()
                self.signal_label.emit("æ­£åœ¨ä¸ºæ‚¨æ¯æ—¥è¯µè¯»......")
                self.signal_p.emit(4)
                end,key_sucess=open_jdsd(mail,info_user,info_key)
                close_proxy()
                if key_sucess==1:
                        today=datetime.date.today()
                        day_insert(str(today))
                        self.signal_label.emit(end)
                        self.signal_p.emit(5)
                        time.sleep(3)
                        if count_judge()!=0 and count_judge()%10==0:
                                self.signal_label.emit("å·²ç»è¿è¡Œäº†{}æ¬¡,ç‚¹ç‚¹èµåŠ©å§~~~".format(count_judge()))
                                QDesktopServices.openUrl(QUrl("https://www.hugcode.cc/sponsor/"))
                                time.sleep(3)      
                        count_increase()
                        app.exit()     
                else:
                        self.signal_label.emit("ç™»å½•å¤±è´¥!è¯·é‡æ–°ç‚¹å‡»å¼€å§‹è·å–keyå€¼")
                        user_key_insert("","")
                        return

 
class Ui_Dialog(object):
    def setupUi(self, Dialog):
        Dialog.setObjectName("Dialog")
        Dialog.resize(974, 784)
        Dialog.setStyleSheet("border-radius: 30px;")
        Dialog.setAttribute(Qt.WA_TranslucentBackground)  # çª—ä½“èƒŒæ™¯é€æ˜
        Dialog.setWindowFlags( Qt.FramelessWindowHint|Qt.WindowStaysOnTopHint )  #çª—å£ç½®é¡¶ï¼Œæ— è¾¹æ¡†ï¼Œåœ¨ä»»åŠ¡æ ä¸æ˜¾ç¤ºå›¾æ ‡
        Dialog.setWindowIcon(QIcon(':/nupu.jpg'))
        self.frame = QtWidgets.QFrame(Dialog)
        self.frame.setGeometry(QtCore.QRect(160, 220, 661, 381))
        self.frame.setStyleSheet("background-color: rgb(175,238,238);\n"
"border-radius: 30px;")


        self.frame.setFrameShape(QtWidgets.QFrame.StyledPanel)
        self.frame.setFrameShadow(QtWidgets.QFrame.Raised)
        self.frame.setObjectName("frame")
        self.label = QtWidgets.QLabel(self.frame)
        self.label.setGeometry(QtCore.QRect(290, 10, 100, 100))
        self.label.setStyleSheet('border-radius: {}px;'.format(self.label.width()//2))
        self.label.setFixedSize(self.label.width(), self.label.width())
        pixmap=QIcon(":/ava.png").pixmap(100,100)
        # åˆ›å»ºä¸€ä¸ªæ–°çš„ QPixmapï¼Œå°†å…¶å¤§å°è®¾ç½®ä¸ºåœ†å½¢çš„å¤§å°
        circle_pixmap = QPixmap(pixmap.size())
        circle_pixmap.fill(Qt.transparent)  # å°† QPixmap çš„èƒŒæ™¯è®¾ç½®ä¸ºé€æ˜
        # åˆ›å»ºä¸€ä¸ª QPainter å¯¹è±¡ï¼Œç”¨äºç»˜åˆ¶åœ†å½¢
        painter = QPainter(circle_pixmap)
        painter.setRenderHint(QPainter.Antialiasing)  # å¯ç”¨åé”¯é½¿
        painter.setBrush(QBrush(pixmap))  # å°†ç»˜åˆ¶çš„åœ†å½¢çš„å¡«å……é¢œè‰²è®¾ç½®ä¸ºåŸå§‹ QPixmap
        painter.drawEllipse(circle_pixmap.rect())  # åœ¨ QPixmap ä¸Šç»˜åˆ¶ä¸€ä¸ªåœ†å½¢
        painter.end()  # ç»“æŸç»˜åˆ¶æ“ä½œ

        self.label.setPixmap(circle_pixmap)

        self.label.setText("")
        self.label.setObjectName("label")
        self.label_4 = QtWidgets.QLabel(self.frame)
        self.label_4.setGeometry(QtCore.QRect(280, 110, 111, 41))
        self.label_4.setStyleSheet("font: 12pt \"åæ–‡ä¸­å®‹\";")
        self.label_4.setObjectName("label_4")
        self.pushButton = QtWidgets.QPushButton(self.frame)
        self.pushButton.setGeometry(QtCore.QRect(290, 150, 31, 31))
        self.pushButton.setStyleSheet("border-radius:12px;")
        self.pushButton.setIcon(QIcon(":/github.png"))
        self.pushButton.setText("")
        self.pushButton.setObjectName("pushButton")
        self.pushButton_2 = QtWidgets.QPushButton(self.frame)
        self.pushButton_2.setGeometry(QtCore.QRect(350, 150, 31, 31))
        self.pushButton_2.setStyleSheet("border-radius:12px;")
        self.pushButton_2.setIcon(QIcon(":/gitee.png"))
        self.pushButton_2.setText("")
        self.pushButton_2.setObjectName("pushButton_2")
        self.pushButton_3 = QtWidgets.QPushButton(self.frame)
        self.pushButton_3.setGeometry(QtCore.QRect(610, 0, 51, 41))
        self.pushButton_3.setStyleSheet("QPushButton{border-radius:20px;  \n}"
"QPushButton:hover { /* é¼ æ ‡æ‚¬æµ®åœ¨QLineEditæ—¶çš„çŠ¶æ€ */\n"
"    background-color: #B22222;\n"
"    color: #298DFF;\n"
"    selection-background-color: #298DFF;\n"
"    selection-color: #F2F2F2;\n"
"}\n"
)
        self.pushButton_3.setObjectName("pushButton_3")
        self.progressBar = QtWidgets.QProgressBar(self.frame)
        self.progressBar.setGeometry(QtCore.QRect(40, 300, 591, 20))
        self.progressBar.setProperty("value", 0)
        self.progressBar.setObjectName("progressBar")
        self.label_2 = QtWidgets.QLabel(self.frame)
        self.label_2.setGeometry(QtCore.QRect(200, 190, 281, 31))
        self.label_2.setStyleSheet("font: 11pt \"åæ–‡ä¸­å®‹\";")
        self.label_2.setObjectName("label_2")
        self.label_3 = QtWidgets.QLabel(self.frame)
        self.label_3.setGeometry(QtCore.QRect(10, 0, 140, 21))
        self.label_3.setStyleSheet("font: 9pt \"æ–¹æ­£ç²—é»‘å®‹ç®€ä½“\";\n"
"background-color: rgb(85, 170, 255);\n"
"border-radius: 10px;")
        self.label_3.setObjectName("label_3")
        self.lineEdit = QtWidgets.QLineEdit(self.frame)
        self.lineEdit.setGeometry(QtCore.QRect(260, 230, 151, 20))
        self.lineEdit.setStyleSheet("* {\n"
"    outline: none;\n"
"}\n"
"\n"
"QDialog {\n"
"    background: #D6DBE9;\n"
"}\n"
"\n"
"QLineEdit {\n"
"    border: 1px solid #A0A0A0; /* è¾¹æ¡†å®½åº¦ä¸º1pxï¼Œé¢œè‰²ä¸º#A0A0A0 */\n"
"    border-radius: 3px; /* è¾¹æ¡†åœ†è§’ */\n"
"    padding-left: 5px; /* æ–‡æœ¬è·ç¦»å·¦è¾¹ç•Œæœ‰5px */\n"
"    background-color: #F2F2F2; /* èƒŒæ™¯é¢œè‰² */\n"
"    color: #000000; /* æ–‡æœ¬é¢œè‰² */\n"
"    selection-background-color: #A0A0A0; /* é€‰ä¸­æ–‡æœ¬çš„èƒŒæ™¯é¢œè‰² */\n"
"    selection-color: #F2F2F2; /* é€‰ä¸­æ–‡æœ¬çš„é¢œè‰² */\n"
"    font-family: \"Microsoft YaHei\"; /* æ–‡æœ¬å­—ä½“æ— */\n"
"    font-size: 10pt; /* æ–‡æœ¬å­—ä½“å¤§å° */\n"
"}\n"
"\n"
"QLineEdit:hover { /* é¼ æ ‡æ‚¬æµ®åœ¨QLineEditæ—¶çš„çŠ¶æ€ */\n"
"    border: 1px solid #298DFF;\n"
"    border-radius: 3px;\n"
"    background-color: #F2F2F2;\n"
"    color: #298DFF;\n"
"    selection-background-color: #298DFF;\n"
"    selection-color: #F2F2F2;\n"
"}\n"
"\n"
"QLineEdit[echoMode=\"2\"] { /* QLineEditæœ‰è¾“å…¥æ©ç æ—¶çš„çŠ¶æ€ */\n"
"    lineedit-password-character: 9679;\n"
"    lineedit-password-mask-delay: 2000;\n"
"}\n"
"\n"
"QLineEdit:disabled { /* QLineEditåœ¨ç¦ç”¨æ—¶çš„çŠ¶æ€ */\n"
"    border: 1px solid #CDCDCD;\n"
"    background-color: #CDCDCD;\n"
"    color: #B4B4B4;\n"
"}\n"
"\n"
"QLineEdit:read-only { /* QLineEditåœ¨åªè¯»æ—¶çš„çŠ¶æ€ */\n"
"    background-color: #CDCDCD;\n"
"    color: #F2F2F2;\n"
"}\n"
"")
        mail=mail_judge()
        self.lineEdit.setText(mail)
        self.lineEdit.setObjectName("lineEdit")
        self.label_5 = QtWidgets.QLabel(self.frame)
        self.label_5.setGeometry(QtCore.QRect(170, 360, 341, 21))  
        self.label_5.setStyleSheet("font: 10pt \"æ–¹æ­£ç²—é»‘å®‹ç®€ä½“\";\n"
"background-color: rgb(0, 170, 127);\n"
"border-radius: 10px;")
        self.label_5.setObjectName("label_5")
        self.pushButton_4 = QtWidgets.QPushButton(self.frame)
        self.pushButton_4.setGeometry(QtCore.QRect(300, 260, 71, 21))
        self.pushButton_4.setStyleSheet("QPushButton {\n"
"    border: 1px solid #A0A0A0; /* è¾¹æ¡†å®½åº¦ä¸º1pxï¼Œé¢œè‰²ä¸º#A0A0A0 */\n"
"    border-radius: 3px; /* è¾¹æ¡†åœ†è§’ */\n"
"    background-color: #F0FFFF; /* èƒŒæ™¯é¢œè‰² */\n"
"    color: #000000; /* æ–‡æœ¬é¢œè‰² */\n"
"    selection-background-color: #A0A0A0; /* é€‰ä¸­æ–‡æœ¬çš„èƒŒæ™¯é¢œè‰² */\n"
"    selection-color: #F2F2F2; /* é€‰ä¸­æ–‡æœ¬çš„é¢œè‰² */\n"
"    font-family: \"Microsoft YaHei\"; /* æ–‡æœ¬å­—ä½“æ— */\n"
"    font-size: 10pt; /* æ–‡æœ¬å­—ä½“å¤§å° */\n"
"}\n"
"QPushButton:hover { /* é¼ æ ‡æ‚¬æµ®åœ¨QLineEditæ—¶çš„çŠ¶æ€ */\n"
"    border: 1px solid #298DFF;\n"
"    border-radius: 3px;\n"
"    background-color: #F2F2F2;\n"
"    color: #298DFF;\n"
"    selection-background-color: #298DFF;\n"
"    selection-color: #F2F2F2;\n"
"}\n")
        self.pushButton_4.setObjectName("pushButton_4")
        self.label_6 = QtWidgets.QLabel(self.frame)
        self.label_6.setAlignment(Qt.AlignCenter)
        self.label_6.setGeometry(QtCore.QRect(90, 320, 500, 20))
        #160, 220, 661, 381
        self.label_6.setStyleSheet("font: 11pt \"Agency FB\";\n"
"font: 12pt \"å¾®è½¯é›…é»‘\";text-align: center")
        self.label_6.setText("")
        self.label_6.setObjectName("label_6")

        self.retranslateUi(Dialog)
        QtCore.QMetaObject.connectSlotsByName(Dialog)

    def retranslateUi(self, Dialog):
        _translate = QtCore.QCoreApplication.translate
        Dialog.setWindowTitle(_translate("Dialog", "Dialog"))
        self.frame.setWhatsThis(_translate("Dialog", "<html><head/><body><p><br/></p></body></html>"))
        self.label_4.setText(_translate("Dialog", "å¼€å‘ä½œè€…ï¼šä¸‰æœ¨"))
        self.pushButton_3.setText(_translate("Dialog", "Ã—"))
        self.label_2.setOpenExternalLinks(True)
        self.label_2.setAlignment(Qt.AlignCenter)
        self.label_2.setText('''<a style="font-family: å¾®è½¯é›…é»‘; color: #0000FF; font-size: 10pt;  text-decoration: none" href="http://www.hugcode.cc/"> ğŸ‘‰ä¸ªäººåšå®¢ğŸ‘ˆ  </a>''')
        self.label_3.setOpenExternalLinks(True)
        self.label_3.setText('''<a style="font-family: å¾®è½¯é›…é»‘; color: #000000; font-size: 10pt;  text-decoration: none" href="https://www.hugcode.cc/post/j1205dsd.html">ğŸ‘‰ä½¿ç”¨æ•™ç¨‹&é—®é¢˜åé¦ˆ</a>''')
        self.label_5.setOpenExternalLinks(True)
        self.label_5.setText('''<a style="font-family: å¾®è½¯é›…é»‘; color: #0000FF; font-size: 10pt;  text-decoration: none" href="https://www.hugcode.cc/sponsor/"> å¦‚æœä½ è§‰å¾—æœ¬è½¯ä»¶å¥½ç”¨ï¼Œå¯ä»¥ç‚¹å‡»è¿™é‡Œæ”¯æŒä½œè€…~ğŸ’°ğŸ’°ğŸ’° https://www.hugcode.cc/sponsor/</a>''')
        self.pushButton_4.setText(_translate("Dialog", "å¼€å§‹"))
        self.pushButton.clicked.connect(self.github)
        self.pushButton_2.clicked.connect(self.gitee)
        self.pushButton_4.clicked.connect(self.start_auto)
        self.lineEdit.setPlaceholderText("è¯·è¾“å…¥ä½ çš„é‚®ç®±(å¿…å¡«)")
        self.pushButton_3.clicked.connect(self.close)
        if count_judge()==0:
                count_increase()
                QDesktopServices.openUrl(QUrl("https://www.hugcode.cc/post/j1205dsd.html"))
        self.progressBar.setRange(0, 5)
        info_user,info_key=user_key_judge()
        info_mail=mail_judge()
        if info_user !="" and info_key!= "" and info_mail!="":
                self.start_auto()

    def github(self):
        webbrowser.open('https://github.com/Gomorebug/auto-jdsd', new=2)
    def gitee(self):
        webbrowser.open('https://gitee.com/Gomorebug')
    def close(self):
        global index
        if progress[index].is_alive():
                progress[index].terminate()
                progress[index].join()
        close_proxy()
        app.quit()
    def start_auto(self):
        # åˆ›å»ºçº¿ç¨‹
        mail_line=self.lineEdit.text()
        self.thread = MyThread(mail_line)
        # è¿æ¥ä¿¡å·
        self.thread.signal_label.connect(self.call_backlabel)  # è¿›ç¨‹è¿æ¥å›ä¼ åˆ°GUIçš„äº‹ä»¶
        self.thread.signal_p.connect(self.call_backprogress)
        # å¼€å§‹çº¿ç¨‹
        self.thread.start()
    def call_backlabel(self, msg):
        self.label_6.setText(msg)  # å°†çº¿ç¨‹çš„å‚æ•°ä¼ å…¥è¿›åº¦æ¡
    def call_backprogress(self,msg):
        self.progressBar.setValue(msg)

if __name__ == '__main__':
        if not os.path.exists(user_path):     
                init_db()
        day=datetime.date.today()
        if(str(day)==day_judge()):
               sys.exit()
        multiprocessing.freeze_support()
        progress=[]
        for i in range(20):
                mitm=multiprocessing.Process(target=start_mitm)
                progress.append(mitm)
        index=0
        # # progress=multiprocessing.Process(target=start_mitm)
        app = QtWidgets.QApplication(sys.argv)
        MainWindow = QtWidgets.QMainWindow()
        ui = Ui_Dialog()
        ui.setupUi(MainWindow)
        MainWindow.show()
        sys.exit(app.exec_())